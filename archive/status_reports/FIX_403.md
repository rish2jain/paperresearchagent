# Fix 403 Forbidden Error

Your NGC API key test failed with 403 Forbidden. This happens when:
1. **Licenses not accepted** on NGC website, OR
2. **API key has docker permissions only** (not full API access)

## Step 1: Accept ALL Required Licenses

Open these 3 URLs and click **"Get NIM"** or **"Subscribe"** on each:

### 1. Reasoning NIM (REQUIRED)
```
https://catalog.ngc.nvidia.com/orgs/nim/teams/nvidia/containers/llama-3.1-nemotron-nano-8b-v1
```
Click: **"Get NIM"** ‚Üí Accept license

### 2. Embedding NIM (REQUIRED)
```
https://catalog.ngc.nvidia.com/orgs/nim/teams/nvidia/containers/nv-embedqa-e5-v5
```
Click: **"Get NIM"** ‚Üí Accept license

### 3. Base Llama Model (REQUIRED)
```
https://catalog.ngc.nvidia.com/orgs/nim/teams/meta/containers/llama-3.1-8b-instruct
```
Click: **"Get NIM"** ‚Üí Accept license

### Verify Licenses Accepted
```
https://org.ngc.nvidia.com/subscriptions
```
You should see all 3 models listed under "Active Subscriptions"

---

## Step 2: Generate New NGC API Key with Full Permissions

Your current key might only have Docker registry permissions. Generate a new one:

### 2.1 Go to NGC API Key Page
```
https://org.ngc.nvidia.com/setup/api-key
```

### 2.2 Generate New Key
1. Click **"Generate API Key"**
2. **Important**: Select **"Full Access"** or ensure these permissions:
   - ‚úÖ NGC Registry: Read
   - ‚úÖ NGC Private Registry: Read
   - ‚úÖ NGC API: Full Access (this is the key one!)
3. Copy the new key (starts with `nvapi-`)

### 2.3 Test Your New Key
```bash
# Export new key
export NGC_API_KEY='nvapi-YOUR-NEW-KEY-HERE'

# Test it directly
curl -H "Authorization: Bearer $NGC_API_KEY" \
  https://api.ngc.nvidia.com/v2/org/nim/team/nvidia/models

# Should return JSON with model list (not "Unauthorized" or "Forbidden")
```

---

## Step 3: Wait for License Propagation

**Important**: After accepting licenses, wait **10 minutes** before trying again. NGC licenses can take 5-10 minutes to propagate.

```bash
# Wait 10 minutes, then run:
./scripts/update-ngc-key.sh
```

---

## Step 4: If Still Getting 403

### Check Your Docker Credentials

Your docker pull works, so let's see what credentials docker is using:

```bash
# Method 1: Check docker config
cat ~/.docker/config.json

# Method 2: Decode docker auth
cat ~/.docker/config.json | jq -r '.auths."nvcr.io".auth' | base64 -d

# The format is: $oauthtoken:<NGC_API_KEY>
# Copy the part after the colon - that's your working key
```

### Alternative: Use Your Working Docker Key

```bash
# Extract key from docker config
DOCKER_KEY=$(cat ~/.docker/config.json | jq -r '.auths."nvcr.io".auth' | base64 -d | cut -d':' -f2)

# Export it
export NGC_API_KEY="$DOCKER_KEY"

# Test it
curl -H "Authorization: Bearer $NGC_API_KEY" \
  https://api.ngc.nvidia.com/v2/org/nim/team/nvidia/models
```

---

## Summary: Do These in Order

1. ‚úÖ Accept licenses on all 3 NGC URLs above
2. ‚è≥ Wait 10 minutes for propagation
3. üîë Generate NEW API key with **"Full Access"**
4. üß™ Test new key with curl command
5. ‚ôªÔ∏è Run `./scripts/update-ngc-key.sh` again

---

## Expected Success Output

When it works, you'll see:

```bash
./scripts/update-ngc-key.sh

üîë NGC API Key Update Script
=============================

‚úÖ NGC_API_KEY environment variable found
üß™ Testing NGC API key...
‚úÖ NGC API key is valid and working!

üîÑ Updating Kubernetes secrets...
‚úÖ Updated nvidia-ngc-secret
‚úÖ Updated ngc-secret (Docker registry)

‚ôªÔ∏è  Restarting NIM deployments...
```

---

**Need help?** Let me know which step fails.
